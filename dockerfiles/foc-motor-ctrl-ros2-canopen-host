# Copyright (C) 2024, Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

FROM arm64v8/ros:humble

# Change default shell
SHELL ["/bin/bash", "-c"]

# To avoid configuring tzdata
ARG DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update -y
RUN apt-get install -y vim iproute2 can-utils

# Install ROS2 CANopen
RUN mkdir -p /root/ros_ws/src
WORKDIR /root/ros_ws/src
RUN git clone https://github.com/ros-industrial/ros2_canopen.git
WORKDIR /root/ros_ws/src/ros2_canopen
RUN git checkout humble
RUN git checkout 1dd817c67c6b1b1dee53e4851f1bc3c391d6ff43
WORKDIR /root/ros_ws
RUN rosdep update
RUN rosdep install --from-paths src/ros2_canopen --ignore-src -r -y

# Copy master code
WORKDIR /root
# TODO: Change to github link
#
RUN git clone https://gitenterprise.xilinx.com/SOM/foc-motor-ctrl.git
WORKDIR /root/foc-motor-ctrl
RUN git checkout pj/canopen_proto
#
#RUN git clone https://github.com/Xilinx/foc-motor-ctrl.git
#END TODO
WORKDIR /root/foc-motor-ctrl
RUN mv /root/foc-motor-ctrl/test/ros2_canopen /root/foc-motor-ctrl/test/foc_motor
RUN cp -rL /root/foc-motor-ctrl/test/foc_motor /root/ros_ws/src/ros2_canopen
WORKDIR /root/ros_ws
RUN source /opt/ros/humble/setup.bash && colcon build --executor sequential
RUN apt-get install -y ros-humble-rviz2
WORKDIR /root
