# Copyright (C) 2024, Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

FROM arm64v8/ros:humble

# Change default shell
SHELL ["/bin/bash", "-c"]

# To avoid configuring tzdata
ARG DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt update && apt upgrade -y \
    && apt install -y iproute2 can-utils \
        python3-rosdep \
        python3-argcomplete \
        python3-colcon-common-extensions \
        build-essential \
        pkg-config \
        python3-wheel

# Fetch sources
RUN mkdir -p /root/ros_ws/src
WORKDIR /root/ros_ws/src

# Get ros2 canopen humble sources
# humble-commitid=1dd817c67c6b1b1dee53e4851f1bc3c391d6ff43
RUN git clone -b humble https://github.com/ros-industrial/ros2_canopen.git

# Copy master code
WORKDIR /root
# TODO: Change to github link
#
RUN git clone -b pj/ros2_control https://gitenterprise.xilinx.com/SOM/foc-motor-ctrl.git
#
#RUN git clone https://github.com/Xilinx/foc-motor-ctrl.git
#END TODO
RUN cp -rL /root/foc-motor-ctrl/test/ros2_canopen /root/ros_ws/src/kria_motor_control \
    && rm -rf /root/foc-motor-ctrl

WORKDIR /root/ros_ws
RUN . /opt/ros/humble/setup.sh \
    && rosdep init && rosdep update \
    && rosdep install --from-paths src --ignore-src -r -y \
    && colcon build --executor sequential \
    && . install/setup.sh

WORKDIR /root
